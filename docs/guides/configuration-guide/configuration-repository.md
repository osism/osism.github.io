---
sidebar_label: Configuration repository
sidebar_position: 10
---

# Configuration Repository

The configuration required for OSISM is stored in a single Git monorepo, the configuration repository.

## Configuration repository layout

A configuration repository is always composed of the same basic layout. This section describes what
content is available in a configuration repository. In the section
[Creating a new configuration repository](#creating-a-new-configuration-repository) is the creation
of a new configuration repository documented.

* **`environments` directory**
* **`inventory` directory**
* **`netbox` directory (optional)**
* **`requirements.txt` file**

  In the `requirements.txt` the necessary dependencies are listed to be able to execute Gilt.

* **`gilt.yml` file**

  [Gilt](https://gilt.readthedocs.io) is a Git layering tool. We use Gilt to maintain the image versions,
  Ansible configuration and scripts within the `environments/manager` directory.

  The [current gilt.yml](https://github.com/osism/cfg-generics/blob/main/gilt.yml) file is always
  located in the [osism/cfg-generics](https://github.com/osism/cfg-generics) repository.

## Creating a new configuration repository

The initial content for this repository is generated using the
[cookiecutter](https://github.com/osism/cfg-cookiecutter).

Cookiecutter generates a simple bootstrap configuration for your new cluster by prompting
you for the basic details of the new system environment.

The configuration repository will not be created on the future manager node. It is created on a local
workstation. If the local workstation cannot be used for this purpose, a dedicated virtual system can
be used. More detailed information about this topic can be obtained in the documentation of the
[seed node](../deploy-guide/seed.md).

### Step 1: Preparation

#### Decide where to store the Git repository

The content generated by the cookiecutter in the `output/configuration` directory is
committed to a new Git repository. By default, it is assumed that the configuration
repository is stored on GitHub. This can also be GitLab or an internal Git service
as well.

Host and path to the Git repository are specified via the `git_` parameters. These are
requested in the 2nd step.The `git_` parameters do not specify the path to the cookiecutter
to use.

```
  [8/20] git_host (github.com):
  [9/20] git_port (22):
  [10/20] git_repository (YOUR_ORG/YOUR_NEW_CONFIGURATION_REPOSITORY): regiocloud/configuration
  [11/20] git_username (git):
  [12/20] git_version (main):
```

In this case, the generated configuration in the `output/configuration` directory is
stored on GitHub in the `regiocloud/configuration` repository.

#### Have a look at the parameters reference

At the end of the chapter you find the parameters reference. The parameters listed there are
queried during the execution of Cookiecutter.

### Step 2: Execute cookiecutter to generate the basic layout/configuration

In this example a new configuration repository is created with the defaults. The current stable
version of OSISM is used. The use of latest is described in the section
[Use of latest](#use-of-latest).

The directory `output` is created and used as output volume. It is only necessary to create the directory.

```
mkdir output
```

The cookiecutter is executed within a container. [Docker must be usable on the system](https://docs.docker.com/engine/install/) on which the cookiecutter is to be used. It should also work with podman.

```
docker run \
  -e TARGET_UID="$(id -u)" \
  -e TARGET_GID="$(id -g)" \
  -v $(pwd)/output:/output \
  --rm -it quay.io/osism/cookiecutter
```

After the call, a few parameters are asked for. The parameters are documented in detail in the [Parameters reference](#parameters-reference) section.

```
[1/19] with_ceph (1):
[2/19] with_keycloak (0):
[3/19] ceph_network(192.168.64.0/19):
[4/19] ceph_version (quincy):
[5/19] domain (osism.xyz):
[6/19] fqdn_external (api.osism.xyz):
[7/19] fqdn_internal (api-int.osism.xyz):
[8/19] git_host (github.com):
[9/19] git_port (22):
[10/19] git_repository (YOUR_ORG/YOUR_NEW_CONFIGURATION_REPOSITORY):
[11/19] git_username (git):
[12/19] git_version (main):
[13/19] ip_external (192.168.96.9):
[14/19] ip_internal (192.168.32.9):
[15/19] manager_version (7.0.0):
[16/19] name_server (149.112.112.112):
[17/19] ntp_server (de.pool.ntp.org):
[18/19] openstack_version (2023.2):
[19/19] project_name (configuration):
[...]
```

### Step 3: Upload the new configuration to the remote git repository

Add the initial configuration state to the repository. How to add a deploy key on GitHub is documented in
[Managing deploy keys](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/managing-deploy-keys).
Read permissions are sufficient.

```
$ git clone git@github.com:YOUR_ORG/YOUR_NEW_CONFIGURATION_REPOSITORY.git YOUR_NEW_CONFIGURATION_REPOSITORY
$ cp -r output/configuration/{*,.gitignore} YOUR_NEW_CONFIGURATION_REPOSITORY
$ cd YOUR_NEW_CONFIGURATION_REPOSITORY
$ git add -A .
$ git commit -m "Initial commit after bootstrap"
$ git push
```

The content is now committed to the previously created Git repository.

:::warning

The `secrets` directory is not stored in the Git repository. Its contents can be
stored in a trustworthy location.

The `secrets` directory contains an SSH key pair which is used as a deploy key to
make the configuration repository available on the manager node later. Write access
is not required. The public SSH key is stored in the file `secrets/id_rsa.configuration.pub`.

:::

### Step 4: Post-processing of the generated configuration

The configuration repository that is initially created with the Cookiecutter is not directly usable.
For example, the inventory needs to be built. All further information can be found in the
[Configuration Guide](../configuration-guide/).

The password for Ansible Vault encrypted files, is stored at `secrets/vaultpass`.
The password of the generated Keepass file is `password`. This should be changed if the Keepass file is used.

Version all your configuration changes using git.

## Parameter reference

| Parameter                  | Description                                                                                                                                | Default                                   |
|:---------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------|:------------------------------------------|
| `ceph_network`             | Address range for Ceph's network                                                                                                           | `192.168.64.0/20`                         |
| `ceph_version`             | The version of Ceph. When using a stable OSISM release (`manager_version != latest`), this value is ignored                                | `quincy`                                  |
| `domain`                   | The domain used by hostnames                                                                                                               | `osism.xyz`                               |
| `fqdn_external`            | External API FQDN                                                                                                                          | `api.osism.xyz`                           |
| `fqdn_internal`            | Internal API FQDN                                                                                                                          | `api-int.osism.xyz`                       |
| `git_host`                 | Address of the used Git server                                                                                                             | `github.com`                              |
| `git_port`                 | Port of the used Git server                                                                                                                | `22`                                      |
| `git_repository`           | Path to the git configuration repository                                                                                                   | `YOUR_ORG/YOUR_CONFIGURATION_REPOSITORY`  |
| `git_username`             | Username of the git repository                                                                                                             | `git`                                     |
| `git_version`              | Git branch name                                                                                                                            | `main`                                    |
| `ip_external`              | The external IP address of the API (resolves to `fqdn_external`)                                                                           | `192.168.96.9`                            |
| `ip_internal`              | The internal IP address of the API (resolves to `fqdn_internal`)                                                                           | `192.168.32.9`                            |
| `manager_version`          | The version of OSISM. An overview of available OSISM releases can be found on [release.osism.tech](https://release.osism.tech)             | `7.0.0`                                   |
| `name_server`              | Nameserver. Only one nameserver is set here because the query of multiple values in Cookiecutter is weird. Add more nameservers afterward. | `149.112.112.112`                         |
| `ntp_server`               | NTP server. Only one NTP server is set here because the query of multiple values in Cookiecutter is weird. Add more NTP servers afterward. | `de.pool.ntp.org`                         |
| `openstack_version`        | The version of OpenStack. When using a stable OSISM release (`manager_version != latest`), this value is ignored                           | `2023.2`                                  |
| `project_name`             | Name of the configuration repository directory                                                                                             | `configuration`                           |
| `with_ceph`                | `1` to use Ceph, `0` to not use Ceph                                                                                                       | `1`                                       |
| `with_keycloak`            | `1` to prepare Keycloak integration , `0` to not prepare Keycloak integration                                                              | `0`                                       |

### Use of latest

When you want to use latest this is done via the parameter `manager_version`.
By default, this is always set to the current stable version.

```
manager_version [7.0.0]: latest
```

If the `manager_version` parameter is set to `latest` it is also possible to explicitly
set the `openstack_version` and the `ceph_version`.


## Preparing a new configuration repository

### Manager environment

```none title="environments/manager/hosts"
[manager]
manager01
```

```yaml title="environments/manager/host_vars/manager01.yml"
---
##########################################################
# ansible

ansible_host: 192.168.16.5

##########################################################
# generic

internal_interface: eno1

##########################################################
# network

network_type: netplan
network_ethernets:
  eno1:
    addresses:
      - "192.168.16.10/20"
    gateway4: "192.168.16.1"
    mtu: 1500
```

### Inventory

```none title="inventory/20-roles"
##########################################################
# roles

# NOTE: If netbox is not used, nothing needs to be changed here. In
#       this case this inventory is used as before. The hosts are
#       then managed here as normal.
#
#       If netbox is used this file is only used to store the hosts
#       for the initial import into the netbox.
#
#       After the initial import of the inventory in the netbox,
#       the groups in this file can be emptied. The systems are
#       then assigned to their roles via tags in the netbox.

# The "all" group is not used in OSISM. Therefore it is important
# that all nodes are explicitly listed here.
[generic]
node01

# Nodes that act as manager (sometimes called deployment node)
# are included in this group.
[manager]
manager01

# Nodes which are intended for monitoring services belong to
# this group
[monitoring]

# Nodes that serve as controllers, so things like scheduler,
# API or database run there, of the environment.
[control]

# Virtual systems managed by OpenStack Nova are placed on
# nodes in this group.
[compute]

# Network resources managed by OpenStack Neutron, such as
# L3 routers, are placed on these nodes. This group has nothing
# to do with the general network configuration.
[network]

# Nodes that serve as controllers for Ceph, so things like the
# Ceph Monitor service run here.
[ceph-control]

# The storage available in these systems is provided in the
# form of OSDs for Ceph.
[ceph-resource]

# NOTE: These empty groups are only necessary if netbox is used. After
#       the initial import of the hosts these groups can be commented
#       out. The groups above with the initial hosts can be commented.
#
# [generic]
#
# [manager]
#
# [monitoring]
#
# [control]
#
# [compute]
#
# [network]
#
# [ceph-control]
#
# [ceph-resource]
```

```yaml title="inventory/host_vars/node01.yml"
---
##########################################################
# ansible

# NOTE: Address where the node can be reached via SSH.
ansible_host: 192.168.16.10

##########################################################
# generic

internal_interface: eno1

# NOTE: The address of the internal interface.
internal_address: 192.168.16.10

##########################################################
# netdata

netdata_host_type: client

# NOTE: Uncomment this when this node should be a Netdata server.

# netdata_host_type: server

##########################################################
# network

# NOTE: This is the initial management interface. Further interfaces
#       must be added.

network_type: netplan
network_ethernets:
  eno1:
    addresses:
      - "192.168.16.10/20"
    gateway4: "192.168.16.1"
    mtu: 1500

##########################################################
# kolla

network_interface: eno1

# api_interface:
# bifrost_network_interface:
# dns_interface:
# kolla_external_vip_interface:
# migration_interface:
# neutron_external_interface:
# octavia_network_interface:
# storage_interface:
# tunnel_interface:

##########################################################
# ceph

# NOTE: Uncomment this when this node is a part of the Ceph cluster.

# monitor_address:
# radosgw_address:

# monitor_interface:
# radosgw_interface:

# NOTE: Uncomment this when this node should be a OSD node.

# devices:
#   - /dev/sdb
#   - /dev/sdc
#   - /dev/sdd
#   - /dev/sde
```
